<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <title>글 수정하기</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="firebase_config.js"></script>
    <script src="admin_key.js"></script>
    <script src="auth.js"></script>
</head>
<body>
    <a href="board.html" class="back-button">목록으로</a>
    
    <h1>글 수정하기</h1>

    <form id="edit-form">
        <label for="post-category">말머리:</label><br>
        <select id="post-category" name="post-category" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
        </select><br><br>

        <label for="post-title">제목:</label><br>
        <input type="text" id="post-title" name="post-title"><br><br>

        <label for="post-content">내용:</label><br>
        <textarea id="post-content" name="post-content" rows="10" cols="50"></textarea><br><br>

        <button type="submit">수정 완료</button>
    </form>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        let post = null;

        // 말머리 목록 불러오기
        const categorySelect = document.getElementById('post-category');
        const defaultCategories = ['정보', '일상', '잡담', '질문', '후기', '체험단'];
        
        db.ref('post_categories').once('value').then((snapshot) => {
            const categories = snapshot.val() || defaultCategories;
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.innerText = cat;
                categorySelect.appendChild(option);
            });
        });

        // 기존 데이터 불러오기
        db.ref('posts/' + id).once('value').then((snapshot) => {
            post = snapshot.val();
            if (!post) {
                alert('존재하지 않는 글입니다.');
                window.location.href = 'board.html';
                return;
            }

            const isAdmin = sessionStorage.getItem('isAdmin') === 'true';

            if (isAdmin) {
                document.getElementById('post-category').value = post.category || '일반';
                document.getElementById('post-title').value = post.title;
                document.getElementById('post-content').value = post.content;
            } else {
                const inputPassword = prompt('글 비밀번호를 입력하세요:');
                if (post.password === inputPassword) {
                    document.getElementById('post-category').value = post.category || '일반';
                    document.getElementById('post-title').value = post.title;
                    document.getElementById('post-content').value = post.content;
                } else {
                    alert('비밀번호가 일치하지 않습니다.');
                    window.location.href = `view.html?id=${id}`;
                }
            }
        });

        document.getElementById('edit-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const category = document.getElementById('post-category').value;
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;

            db.ref('posts/' + id).update({
                category: category,
                title: title,
                content: content
            });
            
            alert('수정되었습니다.');
            window.location.href = `view.html?id=${id}`; // 상세 페이지로 복귀
        });
    </script>
</body>
</html>