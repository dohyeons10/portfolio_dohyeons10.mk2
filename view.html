<!DOCTYPE html>
<html lang="ko">
<a href="board.html" class="back-button" id="back-btn">목록으로</a>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="firebase_config.js"></script>
    <script src="admin_key.js"></script>
    <script src="auth.js"></script>
    <title>글 보기</title>
</head>
<body>
    <div class="container">
        <div style="text-align: right; margin-bottom: 10px;">
            <button id="edit-btn" class="edit-button">수정</button>
            <button id="delete-btn" class="delete-button">삭제</button>
        </div>
        <h1 id="view-title" style="text-align: center; margin: 0;">제목 로딩 중...</h1>
        <p id="view-date" class="post-date" style="text-align: right;"></p>
        <hr>
        <div id="view-content" class="post-content" style="min-height: 200px; text-align: left;"></div>

        <hr style="margin: 30px 0; display: none;" id="comment-hr">

        <div class="comments-section" style="display: none;">
            <h3 style="text-align: left;">댓글</h3>
            <ul id="comments-list" class="comments-list"></ul>
            
            <form id="comment-form" style="margin-top: 20px;">
                <input type="text" id="comment-author" placeholder="작성자 (선택)" style="width: 30%; margin-bottom: 5px;">
                <input type="password" id="comment-password" placeholder="비밀번호" style="width: 30%; margin-bottom: 5px; margin-left: 5px;">
                <textarea id="comment-content" placeholder="댓글을 입력하세요" rows="3"></textarea>
                <button type="submit" style="margin-top: 5px; background-color: #6c757d;">댓글 등록</button>
            </form>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        let post = null;
        const postRef = db.ref('posts/' + id);

        if (id) {
            postRef.on('value', (snapshot) => {
                post = snapshot.val();
                if (post) {
                    let categoryLabel = '';
                    if (post.category && post.category !== '수상' && post.category !== '자격증' && post.category !== '대외활동') {
                        categoryLabel = `[${post.category}] `;
                    }
                    document.getElementById('view-title').innerText = categoryLabel + post.title;
                    document.getElementById('view-date').innerText = post.date;
                    document.getElementById('view-content').innerText = post.content;

                    if (post.category === '수상') {
                        document.getElementById('back-btn').href = 'awards_board.html';
                        document.getElementById('view-date').style.display = 'none';
                    } else if (post.category === '자격증') {
                        document.getElementById('back-btn').href = 'certifications_board.html';
                        document.getElementById('view-date').style.display = 'none';
                    } else if (post.category === '대외활동') {
                        document.getElementById('back-btn').href = 'activities_board.html';
                        document.getElementById('view-date').style.display = 'none';
                    } else {
                        document.getElementById('view-date').style.display = 'block';
                        document.getElementById('comment-hr').style.display = 'block';
                        document.querySelector('.comments-section').style.display = 'block';
                        renderComments(post.comments);
                    }

                    const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                    if (!isAdmin) {
                        document.getElementById('delete-btn').style.display = 'none';
                        document.getElementById('edit-btn').style.display = 'none';
                    }

                } else {
                    alert('존재하지 않는 글입니다.');
                    window.location.href = 'board.html';
                }
            });
        } else {
            alert('잘못된 접근입니다.');
            window.location.href = 'board.html';
        }

        const commentsList = document.getElementById('comments-list');

        function renderComments(commentsData) {
            commentsList.innerHTML = '';
            if (!commentsData) return;

            Object.keys(commentsData).forEach(key => {
                const comment = commentsData[key];
                const li = document.createElement('li');
                li.className = 'comment-item';
                li.innerHTML = `
                    <div class="comment-header">
                        <strong>${comment.author || '익명'}</strong>
                        <span style="margin-left: auto; font-size: 0.8em; color: #888;">${comment.date}</span>
                        <button class="delete-comment-btn" onclick="deleteComment('${key}', '${comment.password}')">&times;</button>
                    </div>
                    <p class="comment-text">${comment.content}</p>
                `;
                commentsList.appendChild(li);
            });
        }

        // 댓글 등록 이벤트
        document.getElementById('comment-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const authorInput = document.getElementById('comment-author');
            const passwordInput = document.getElementById('comment-password');
            const contentInput = document.getElementById('comment-content');
            
            if (contentInput.value.trim() && passwordInput.value.trim()) {
                db.ref('posts/' + id + '/comments').push({
                    author: authorInput.value.trim(),
                    password: passwordInput.value.trim(),
                    content: contentInput.value.trim(),
                    date: new Date().toLocaleDateString()
                });
                contentInput.value = '';
                passwordInput.value = '';
            } else {
                alert('댓글 내용과 비밀번호를 입력해주세요.');
            }
        });

        // 댓글 삭제 함수
        window.deleteComment = function(commentId, password) {
            const isAdmin = sessionStorage.getItem('isAdmin') === 'true';

            if (isAdmin) {
                if (confirm('관리자 권한으로 댓글을 삭제하시겠습니까?')) {
                    db.ref('posts/' + id + '/comments/' + commentId).remove();
                }
            } else {
                const inputPassword = prompt('댓글 비밀번호를 입력하세요:');
                if (password === inputPassword) {
                    if (confirm('댓글을 삭제하시겠습니까?')) {
                        db.ref('posts/' + id + '/comments/' + commentId).remove();
                    }
                } else if (inputPassword !== null) {
                    alert('비밀번호가 일치하지 않습니다.');
                }
            }
        };

        document.getElementById('edit-btn').onclick = function() {
            const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
            
            if (post && (post.category === '수상' || post.category === '자격증' || post.category === '대외활동') && !isAdmin) {
                alert('이 게시글은 관리자만 수정할 수 있습니다.');
                return;
            }

            if (post && post.category === '수상') {
                window.location.href = `awards_board_edit.html?id=${id}`;
            } else if (post && post.category === '자격증') {
                window.location.href = `certifications_board_edit.html?id=${id}`;
            } else if (post && post.category === '대외활동') {
                window.location.href = `activities_board_edit.html?id=${id}`;
            } else {
                window.location.href = `edit.html?id=${id}`;
            }
        };

        document.getElementById('delete-btn').onclick = function() {
            const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
            
            if (post && (post.category === '수상' || post.category === '자격증' || post.category === '대외활동') && !isAdmin) {
                alert('이 게시글은 관리자만 삭제할 수 있습니다.');
                return;
            }

            let redirectUrl = 'board.html';
            if (post && post.category === '수상') {
                redirectUrl = 'awards_board.html';
            } else if (post && post.category === '자격증') {
                redirectUrl = 'certifications_board.html';
            } else if (post && post.category === '대외활동') {
                redirectUrl = 'activities_board.html';
            }

            if (isAdmin) {
                if (confirm('정말 삭제하시겠습니까?')) {
                    postRef.off(); // 리스너 해제 (존재하지 않는 글 알림 방지)
                    postRef.remove().then(() => {
                        alert('삭제되었습니다.');
                        window.location.href = redirectUrl;
                    });
                }
            } else {
                const inputPassword = prompt('글 비밀번호를 입력하세요:');
                if (post.password === inputPassword) {
                    if (confirm('정말 삭제하시겠습니까?')) {
                        postRef.off(); // 리스너 해제
                        postRef.remove().then(() => {
                            alert('삭제되었습니다.');
                            window.location.href = redirectUrl;
                        });
                    }
                } else if (inputPassword !== null) {
                    alert('비밀번호가 일치하지 않습니다.');
                }
            }
        };
    </script>
</body>
</html>